@* ======================================================================
   AIMS View: AuditLog/Index (Merged)
   ----------------------------------------------------------------------
   Purpose
   - Aligns with Admin table chrome
   - Supports client-side filtering + realtime/polling
   - Adds pagination chrome consistent with Search page

   Conventions
   1) Layout
      - Inherits global layout: ~/Views/Shared/_Layout.cshtml

   2) Styles
      - Admin chrome: ~/css/pages/admin.index.css
      - Pager:        ~/css/components/_Pager.css
      - Page CSS:     ~/css/pages/auditlog.index.css

   3) Scripts
      - Page JS:      ~/js/pages/auditlog.index.js
      - Inline: Task 4A modal trigger (kept)
      - SignalR:      ~/lib/microsoft/signalr/dist/browser/signalr.min.js

   4) Routing
      - Controller: Controllers/Mvc/AuditLogController.cs
      - Action:     Index()
      - Route:      /AuditLog or /AuditLog/Index

   5) Notes
      - Indentation: 4 spaces
      - Table body is client-filled; no demo rows
   ====================================================================== *@

@inject Microsoft.Extensions.Configuration.IConfiguration Config

@{
    ViewData["Title"] = "Audit Log";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@section Styles {
    <!-- bring in the Admin table baseline -->
    <link rel="stylesheet" href="~/css/pages/admin.index.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/components/_Pager.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/pages/auditlog.index.css" asp-append-version="true" />
}

<div class="audit-log-container">
    <div class="d-flex align-items-center justify-content-between mb-3">
        <h1 class="audit-log-title m-0">Audit Log</h1>

        <!-- Filter icon (from Task 4A) -->
        <div class="ms-3">
            @await Html.PartialAsync("_FilterIcon", new ViewDataDictionary(ViewData) {
            ["Id"] = "auditLogFilter",
                        ["Label"] = "Search Logs"
                        })
        </div>
    </div>

    @* hidden config for JS (polling interval / batch size / feature flags) *@
    <div id="auditlog-config" data-poll-interval="@Config["Audit:PollingIntervalMs"]"
        data-max-batch="@Config["Audit:MaxBatchSize"]" data-feature-realtime="@Config["Feature:AuditRealTime"]"
        data-feature-polling="@Config["Feature:AuditPollingFallback"]" hidden></div>

    <!-- Admin-style chrome -->
    <div class="table-wrapper">
        <div class="admin-table-chrome">
            <!-- Fixed header -->
            <table class="admin-table-header">
                <thead>
                    <tr>
                        <th class="al-col-1">Log ID</th>
                        <th class="al-col-2">Timestamp</th>
                        <th class="al-col-3">User ID</th>
                        <th class="al-col-4">Action</th>
                        <th class="al-col-5">Asset ID</th>
                        <th class="al-col-6">Previous Value</th>
                        <th class="al-col-7">New Value</th>
                        <th class="al-col-8">Description</th>
                    </tr>
                </thead>
            </table>

            <!-- Scrollable body -->
            <div class="admin-table-scroll">
                <table class="admin-table-body audit-log-table" id="auditTable">
                    <tbody id="auditTableBody"><!-- filled by JS (realtime/polling/paging) --></tbody>
                </table>
            </div>
        </div>
    </div>

    @* ----------- Pager (same markup/classes as Search) ------------------ *@
    <div id="audit-pager" class="search-pager" hidden>
        <button id="pg-prev" class="pager-btn" type="button" aria-label="Previous page">Prev</button>
        <span id="pg-status" class="pager-status" role="status" aria-live="polite"></span>
        <button id="pg-next" class="pager-btn" type="button" aria-label="Next page">Next</button>
    </div>
    @* -------------------------------------------------------------------- *@
</div>

@* Include the existing modal from Task 4A *@
@await Html.PartialAsync("_SearchLogsModal")

@section Scripts {
    <script src="~/lib/microsoft/signalr/dist/browser/signalr.min.js" asp-append-version="true"></script>
    <script src="~/js/pages/auditlog.index.js" asp-append-version="true" defer></script>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // Target the FilterIcon button from Task 4A
            const root = document.querySelector('[data-component="filter-icon"][data-id="auditLogFilter"]');
            if (!root) return;

            const btn = root.querySelector('.aims-filter-btn');
            const dropdown = root.querySelector('.dropdown-menu');
            if (dropdown) dropdown.remove(); // remove old dropdown menu

            if (btn) {
                btn.removeAttribute('data-bs-toggle');
                btn.removeAttribute('aria-expanded');
                btn.setAttribute('type', 'button');
            }

            const modalEl = document.getElementById('searchLogsModal');
            if (btn && modalEl && window.bootstrap && bootstrap.Modal) {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    bootstrap.Modal.getOrCreateInstance(modalEl).show();
                });
            }
        });
    </script>
}