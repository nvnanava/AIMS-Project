@* ======================================================================
   AIMS View: AuditLog/Index (Merged)
   ----------------------------------------------------------------------
   Purpose
   - Align UI with Admin table chrome and reuse existing Search Logs modal
   - Preserve realtime/polling hooks and IDs used by page JS (SignalR + polling)
   - (Temporary) Keep inline script from MAIN to open modal via FilterIcon
   ====================================================================== *@

@inject Microsoft.Extensions.Configuration.IConfiguration Config

@{
    ViewData["Title"] = "Audit Log";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@section Styles {
    <!-- bring in the Admin table baseline -->
    <link rel="stylesheet" href="~/css/pages/admin.index.css" asp-append-version="true" />
    <!-- page-specific styles -->
    <link rel="stylesheet" href="~/css/pages/auditlog.index.css" asp-append-version="true" />
}

<div class="audit-log-container">
    @* hidden config for JS (polling interval / batch size / feature flags) *@
    <div id="auditlog-config"
         data-poll-interval="@Config["Audit:PollingIntervalMs"]"
         data-max-batch="@Config["Audit:MaxBatchSize"]"
         data-feature-realtime="@Config["Feature:AuditRealTime"]"
         data-feature-polling="@Config["Feature:AuditPollingFallback"]"
         hidden></div>

    <div class="d-flex align-items-center justify-content-between mb-3">
        <h1 class="audit-log-title m-0">Audit Log</h1>

        <!-- Filter icon (from Task 4A) -->
        <div class="ms-3">
            @await Html.PartialAsync("_FilterIcon", new ViewDataDictionary(ViewData) {
                ["Id"] = "auditLogFilter",
                ["Label"] = "Search Logs"
            })
        </div>
    </div>

    <!-- Admin-style chrome -->
    <div class="table-wrapper">
        <div class="admin-table-chrome">
            <!-- Fixed header -->
            <table class="admin-table-header">
                <thead>
                    <tr>
                        <th class="al-col-1">Log ID</th>
                        <th class="al-col-2">Timestamp</th>
                        <th class="al-col-3">User ID</th>
                        <th class="al-col-4">Action</th>
                        <th class="al-col-5">Asset ID</th>
                        <th class="al-col-6">Previous Value</th>
                        <th class="al-col-7">New Value</th>
                        <th class="al-col-8">Description</th>
                    </tr>
                </thead>
            </table>

            <!-- Scrollable body -->
            <div class="admin-table-scroll">
                <!-- Give the scrolling table/rows the IDs our JS expects -->
                <table class="admin-table-body" id="auditTable">
                    <tbody id="auditTableBody">
                        <tr>
                            <td class="al-col-1">1</td>
                            <td class="al-col-2">2025-04-16 10:12 AM</td>
                            <td class="al-col-3">U001</td>
                            <td class="al-col-4">Assign</td>
                            <td class="al-col-5">A101</td>
                            <td class="al-col-6">Unassigned</td>
                            <td class="al-col-7">Laptop-001</td>
                            <td class="al-col-8">Assigned Laptop to John Smith</td>
                        </tr>
                        <tr>
                            <td class="al-col-1">2</td>
                            <td class="al-col-2">2025-04-16 09:50 AM</td>
                            <td class="al-col-3">U002</td>
                            <td class="al-col-4">Create</td>
                            <td class="al-col-5">A102</td>
                            <td class="al-col-6">N/A</td>
                            <td class="al-col-7">Monitor-003</td>
                            <td class="al-col-8">Created new monitor asset</td>
                        </tr>
                        <tr>
                            <td class="al-col-1">3</td>
                            <td class="al-col-2">2025-04-15 05:30 PM</td>
                            <td class="al-col-3">U003</td>
                            <td class="al-col-4">Update</td>
                            <td class="al-col-5">A103</td>
                            <td class="al-col-6">Monitor-001</td>
                            <td class="al-col-7">Monitor-003</td>
                            <td class="al-col-8">Updated asset name and status</td>
                        </tr>
                        <tr>
                            <td class="al-col-1">4</td>
                            <td class="al-col-2">2025-04-15 04:17 PM</td>
                            <td class="al-col-3">U001</td>
                            <td class="al-col-4">Unassign</td>
                            <td class="al-col-5">A104</td>
                            <td class="al-col-6">Mouse-002</td>
                            <td class="al-col-7">Unassigned</td>
                            <td class="al-col-8">Removed asset from user Ava</td>
                        </tr>
                        <tr>
                            <td class="al-col-1">5</td>
                            <td class="al-col-2">2025-04-15 03:42 PM</td>
                            <td class="al-col-3">U004</td>
                            <td class="al-col-4">Delete</td>
                            <td class="al-col-5">A105</td>
                            <td class="al-col-6">Keyboard-001</td>
                            <td class="al-col-7">Deleted</td>
                            <td class="al-col-8">Deleted broken keyboard asset</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

@* Include the existing modal from Task 4A *@
@await Html.PartialAsync("_SearchLogsModal")

@section Scripts {
    <!-- Realtime + page logic -->
    <script src="~/lib/microsoft/signalr/dist/browser/signalr.min.js" asp-append-version="true"></script>
    <script src="~/js/pages/auditlog.index.js" asp-append-version="true" defer></script>

    <!-- Temporary inline script (kept from MAIN) to wire FilterIcon -> Modal -->
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // Target the FilterIcon button from Task 4A
            const root = document.querySelector('[data-component="filter-icon"][data-id="auditLogFilter"]');
            if (!root) return;

            const btn = root.querySelector('.aims-filter-btn');
            const dropdown = root.querySelector('.dropdown-menu');
            if (dropdown) dropdown.remove(); // remove old dropdown menu

            if (btn) {
                btn.removeAttribute('data-bs-toggle');
                btn.removeAttribute('aria-expanded');
                btn.setAttribute('type', 'button');
            }

            const modalEl = document.getElementById('searchLogsModal');
            if (btn && modalEl && window.bootstrap && bootstrap.Modal) {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    bootstrap.Modal.getOrCreateInstance(modalEl).show();
                });
            }
        });
    </script>
}