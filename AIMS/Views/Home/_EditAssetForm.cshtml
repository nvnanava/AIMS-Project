@* Views/Home/_EditAssetForm.cshtml *@
<div class="modal fade" id="editAssetModal" tabindex="-1" aria-labelledby="editAssetModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title" id="editAssetModalLabel">Edit Asset</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <form id="editAssetForm" novalidate>
          <!-- Hidden primary key (if you use one) -->
          <input type="hidden" id="editId" name="id" />

          <div id="editAssetErrorMessage" class="alert alert-danger" style="display:none;"></div>

          <div class="mb-3">
            <label for="editName" class="form-label">Asset Name</label>
            <input type="text" id="editName" name="name" class="form-control" placeholder="Enter asset name" required>
            <div class="invalid-feedback">Asset Name is required.</div>
          </div>

          <div class="mb-3">
            <label for="editType" class="form-label">Type</label>
            <select id="editType" name="type" class="form-control"></select>

          </div>

          <div class="mb-3">
            <label for="editTag" class="form-label">Tag Number</label>
            <input type="text" id="editTag" name="tagNumber" class="form-control" placeholder="Enter tag number"
              required>
            <div class="invalid-feedback">Tag Number is required.</div>
          </div>

          <div class="mb-3">
            <label for="editStatus" class="form-label">Status</label>
            <select id="editStatus" name="status" class="form-select">
              <option value="">-- Select status --</option>
              <option>Available</option>
              <option>Assigned</option>
              <option>Surveyed</option>
              <option>Marked for Survey</option>
              <option>In Repair</option>
            </select>
          </div>

          <div class="mb-3">
            <label for="editComments" class="form-label">Comments</label>
            <textarea id="editComments" name="comments" class="form-control" rows="4"
              placeholder="Add any remarks..."></textarea>
          </div>

          <!-- Back-compat for your older workflow -->
          <div class="mb-3 form-check">
            <input type="checkbox" class="form-check-input" id="markForSurvey" name="markForSurvey">
            <label class="form-check-label" for="markForSurvey">Mark for Survey</label>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button type="submit" class="btn btn-primary">Save Changes</button>
          </div>
        </form>
      </div>

    </div>
  </div>
</div>

<script>
  //second script to mirror above with ajax submission

  function fetchUniqueAssetTypes() {
    return fetch('/api/assets/types/unique', {
          headers: { "Accept": "application/json, text/json" },
          cache: "no-store"
        }).then(res => res.json())
        .catch(e => {
          throw new Error(`Fallback HTTP ${res.status}`);
        })

  }

  function valueToSend(el) {
    if(el == null) {
      throw new Error("Incorrect element specified");
    }
    return el.value !== el.dataset.defaultValue ? el.value.trim() : null
  }
  document.addEventListener('DOMContentLoaded', () => {
    const modalEl = document.getElementById('editAssetModal');
    if (!modalEl) return;

    const form = modalEl.querySelector('#editAssetForm');
    const errorBox = modalEl.querySelector('#editAssetErrorMessage');
    const editId = modalEl.querySelector('#editId');
    const nameInput = modalEl.querySelector("#editName");
    const editType = modalEl.querySelector('#editType');
    const tagInput = modalEl.querySelector('#editTag');
    const typeInput = modalEl.querySelector('#editType');
    const statusSel = modalEl.querySelector('#editStatus');
    const commentsInput = modalEl.querySelector('#editComments')
    const mfs = modalEl.querySelector('#markForSurvey');

    async function populateAssetTypes() {
      try {
        const assetTypes = await fetchUniqueAssetTypes();
        typeInput.replaceChildren();

        assetTypes.forEach(type => {
          const option = document.createElement("option");
          option.value = type;
          option.text = type;
          typeInput.appendChild(option);
        });
      } catch (error) {
        console.error("Failed to populate asset types:", error);
      }
    }
    //populates the form with the element's data attributes when opened
    modalEl.addEventListener('show.bs.modal', async function (event) {
      const button = event.relatedTarget;
      if (!button) return;

      await populateAssetTypes();
      editId.value = button.getAttribute('data-hardware-id') || button.getAttribute('data-software-id');
      editId.dataset.defaultValue = editId.value;
      nameInput.value = button.getAttribute('data-name') || '';
      nameInput.dataset.defaultValue = editId.value;
      editType.value = button.getAttribute('data-type') || '';
      editType.dataset.defaultValue = editId.value;
      tagInput.value = button.getAttribute('data-tag') || '';
      tagInput.dataset.defaultValue = editId.value;
      statusSel.value = button.getAttribute('data-status') || '';
      statusSel.dataset.defaultValue = editId.value;
      commentsInput.value = button.getAttribute('data-comments') || '';
      commentsInput.dataset.defaultValue = editId.value;
    });


    form.addEventListener('submit', async function (e) {
      e.preventDefault();

      errorBox.style.display = 'none';
      errorBox.innerText = '';

      if (!tagInput.value.trim()) {
        tagInput.classList.add('is-invalid');
        errorBox.innerText = 'Tag Number is required.';
        errorBox.style.display = 'block';
        return;
      } else {
        tagInput.classList.remove('is-invalid');
      }


      if (!nameInput.value.trim()) {
        nameInput.classList.add('is-invalid');
        errorBox.innerText = 'Asset Name is required.';
        errorBox.style.display = 'block';
        return;
      } else {
        nameInput.classList.remove('is-invalid');
      }

      const AssetType = this.querySelector('#editType').value.trim()
      let dto;
      let url;

      switch (AssetType) {
        case "Software":
          url = "/api/software/edit"
          dto = {

            SoftwareID: parseInt(this.querySelector('#editId').value, 10),
            SoftwareName: valueToSend(nameInput),
            SoftwareType: valueToSend(editType)
          }
          break;
        // for now, the rest are hardware
        default:
          url = "/api/hardware/edit"
          dto = {
            HardwareID: parseInt(this.querySelector('#editId').value, 10),
            AssetName: valueToSend(nameInput),
            AssetType: valueToSend(editType),
            AssetTag: valueToSend(tagInput),
            Status: valueToSend(statusSel),
            Comments: valueToSend(commentsInput),
            MarkForSurvey: this.querySelector('#markForSurvey').checked
          }
      } 
      try {
        const id = dto.HardwareID || dto.SoftwareID;
        const res = await fetch(`${url}/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(dto)
        });
        if (!res.ok) {
          const err = await res.json();
          throw new Error(`Failed to update asset: ${Object.values(err).flat().join(' ')}`);
        }
        // Success = close modal and refrehs list
        const modal = bootstrap.Modal.getInstance(modalEl);
        if (modal) modal.hide();

        //reload list after short delay
        const urlParams = new URLSearchParams(window.location.search);
        const category = urlParams.get("category") || "@ViewData["Category"]";
        await new Promise(resolve => setTimeout(resolve, 250));
        loadAssets(category);
      } catch (err) {
        errorBox.innerText = err.message;
        errorBox.style.display = 'block';
      }
    });
    // Sync checkbox <-> status
    if (statusSel && mfs) {
      statusSel.addEventListener('change', function () {
        const v = (this.value || '').toLowerCase();
        mfs.checked = (v.includes('marked for survey') || v.includes('surveyed'));
      });
      mfs.addEventListener('change', function () {
        if (this.checked) {
          // Prefer "Marked for Survey" when the box is checked
          statusSel.value = 'Marked for Survey';
        }
      });
    }
  });
</script>