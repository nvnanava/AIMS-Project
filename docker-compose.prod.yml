services:
  web-prod:
    platform: linux/amd64
    build:
      context: .
      dockerfile: AIMS/Dockerfile.prod
    ports:
      - "${WEB_PORT}:5119"
    environment:
      # --- ASP.NET / .NET runtime toggles (Production) ---
      ASPNETCORE_ENVIRONMENT: Production
      DOTNET_ENVIRONMENT: Production
      ASPNETCORE_URLS: "${ASPNETCORE_URLS}"

      # --- Connection string for prod container-to-container ---
      ConnectionStrings__DockerConnection: "Server=sqlserver-prod,${SQL_PORT};Database=${SQL_DB};User Id=${SQL_USER};Password=${SQL_PASSWORD};TrustServerCertificate=True;Encrypt=False"

      # --- Azure AD IDs from .env ---
      AzureAd__TenantId: ${AZUREAD_TENANT_ID}
      AzureAd__ClientId: ${AZUREAD_CLIENT_ID}

      # --- Secrets-first path ---
      AzureAd__ClientSecretFile: ${AZUREAD_CLIENT_SECRET_FILE}

      # --- Seeder controls ---
      AIMS_SEED_MODE: ${AIMS_SEED_MODE:-basic}
      AIMS_SEED_DIR: ${AIMS_SEED_DIR:-/src/seed}
      AIMS_ALLOW_PROD_SEED: ${AIMS_ALLOW_PROD_SEED:-false}

    secrets:
      - azuread_client_secret
    depends_on:
      sqlserver-prod:
        condition: service_healthy
    networks:
      - new-bridge-net

  sqlserver-prod:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: sqlserver2022-prod
    ports:
      - "${SQL_PORT_HOST}:${SQL_PORT}"
    environment:
      SA_PASSWORD: "${SQL_PASSWORD}"
      ACCEPT_EULA: "Y"
      MSSQL_PID: "Developer"
    volumes:
      - mssql_data_prod:/var/opt/mssql
    restart: unless-stopped
    networks:
      - new-bridge-net
    healthcheck:
      test: [ "CMD-SHELL", "/opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P \"$${SA_PASSWORD}\" -No -Q \"SELECT 1\" -C" ]
      interval: 5s
      timeout: 5s
      retries: 60
      start_period: 45s

secrets:
  azuread_client_secret:
    # In CI/infra, point this to a managed secret file.
    file: ./secrets/azuread_client_secret.txt

networks:
  new-bridge-net:
    driver: bridge

volumes:
  mssql_data_prod: